<!DOCTYPE html>
<html lang="zh-Hans">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 4.2.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/font-awesome.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"yoursite.com","root":"/","scheme":"Pisces","version":"7.7.1","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":false,"show_result":false,"style":null},"back2top":{"enable":true,"sidebar":false,"scrollpercent":false},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":false,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}}};
  </script>

  <meta name="description" content="从小白到大神，一路走来，你我相伴">
<meta property="og:type" content="website">
<meta property="og:title" content="程序猿的进击之路">
<meta property="og:url" content="http://yoursite.com/page/2/index.html">
<meta property="og:site_name" content="程序猿的进击之路">
<meta property="og:description" content="从小白到大神，一路走来，你我相伴">
<meta property="article:author" content="颛顼">
<meta name="twitter:card" content="summary">

<link rel="canonical" href="http://yoursite.com/page/2/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome: true,
    isPost: false
  };
</script>

  <title>程序猿的进击之路</title>
  


  <script>
    var _hmt = _hmt || [];
    (function() {
      var hm = document.createElement("script");
      hm.src = "https://hm.baidu.com/hm.js?6df67afdfc9b547082e81ea60ea510dc";
      var s = document.getElementsByTagName("script")[0];
      s.parentNode.insertBefore(hm, s);
    })();
  </script>




  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>
  <a href="https://github.com/zhuanxuhit" target="_blank" rel="noopener" class="github-corner" aria-label="View source on GitHub"><svg width="80" height="80" viewBox="0 0 250 250" style="fill:#151513; color:#fff; position: absolute; top: 0; border: 0; right: 0;" aria-hidden="true"><path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"></path><path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2" fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"></path><path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z" fill="currentColor" class="octo-body"></path></svg></a><style>.github-corner:hover .octo-arm{animation:octocat-wave 560ms ease-in-out}@keyframes octocat-wave{0%,100%{transform:rotate(0)}20%,60%{transform:rotate(-25deg)}40%,80%{transform:rotate(10deg)}}@media (max-width:500px){.github-corner:hover .octo-arm{animation:none}.github-corner .octo-arm{animation:octocat-wave 560ms ease-in-out}}</style>
    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="Toggle navigation bar">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <div>
      <a href="/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">程序猿的进击之路</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
  </div>

  <div class="site-nav-right"></div>
</div>


<nav class="site-nav">
  
  <ul id="menu" class="menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-fw fa-home"></i>Home</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-fw fa-archive"></i>Archives</a>

  </li>
  </ul>

</nav>
</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content">
            

  <div class="posts-expand">
        
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block home" lang="zh-Hans">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2016/12/19/doctrine1/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/uploads/wechat-qcode.jpg">
      <meta itemprop="name" content="颛顼">
      <meta itemprop="description" content="从小白到大神，一路走来，你我相伴">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="程序猿的进击之路">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          
            <a href="/2016/12/19/doctrine1/" class="post-title-link" itemprop="url">doctrine缘来 之 造轮子</a>
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2016-12-19 09:55:43" itemprop="dateCreated datePublished" datetime="2016-12-19T09:55:43+08:00">2016-12-19</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2020-02-22 20:18:44" itemprop="dateModified" datetime="2020-02-22T20:18:44+08:00">2020-02-22</time>
              </span>

          
            <span id="/2016/12/19/doctrine1/" class="post-meta-item leancloud_visitors" data-flag-title="doctrine缘来 之 造轮子" title="Views">
              <span class="post-meta-item-icon">
                <i class="fa fa-eye"></i>
              </span>
              <span class="post-meta-item-text">Views: </span>
              <span class="leancloud-visitors-count"></span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p><img src="http://bos.nj.bpc.baidu.com/v1/agroup/fa3266866e3cb4c02ea0481a49e044df9a557240" alt=""></p>
<p>本系列是读<strong><em>php data persistence with doctrine2 orm</em></strong>的笔记，本文是第一篇：自己造轮子。</p>
<p>最开始描述下需要构建的系统</p>
<p>一个User可以发表Post，一个Post只有一个作者，User和Post之间彼此引用</p>
<p>一个User可以有多个Roles，User有Roles的引用，但是不能通过Role找到Users</p>
<p>一个User有一个UserInfo，UserInfo中包含了用户的注册信息等，User和UserInfo彼此引用</p>
<p>一个User有一个ContactData，包含email、电话等信息，User单向引用ContactData</p>
<p>一个User可能会有一个life partner，彼此之间互相引用</p>
<p>一个User会有多个friends，关系是单向的</p>
<p>一个Post会有多个标签Tag，Post到Tag是双向关系</p>
<p>一个Post有一个Category，Post到Category时单向关系</p>
<p>一个Category会有subcategories，并且会有parent Category</p>
<p>一个User会有多个Categories，User到Categories是单向关系</p>
<p><img src="http://bos.nj.bpc.baidu.com/v1/agroup/76a586df395fb31c491a06201bf6805e10e706c5" alt="Demo application “Talking” - Domain Model"></p>
<p>在起初这个阶段我们不会直接就是用Doctrine，而是会自己来打造一个ORM，让我们更清楚的了解一个好的ORM需要怎么做。</p>
<h2 id="读数据"><a href="#读数据" class="headerlink" title="读数据"></a>读数据</h2><p>先来看Model：User，部分代码如下：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">User</span> </span>&#123;</span><br><span class="line">    <span class="keyword">const</span> GENDER_MALE                 = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> GENDER_FEMALE               = <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> GENDER_MALE_DISPLAY_VALUE   = <span class="string">"Mr."</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> GENDER_FEMALE_DISPLAY_VALUE = <span class="string">"Mrs."</span>;</span><br><span class="line">	 <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> string</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">assembleDisplayName</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        $displayName = <span class="string">''</span>;</span><br><span class="line">        <span class="keyword">if</span> ( <span class="keyword">$this</span>-&gt;gender == <span class="keyword">self</span>::GENDER_MALE ) &#123;</span><br><span class="line">            $displayName .= <span class="keyword">self</span>::GENDER_MALE_DISPLAY_VALUE;</span><br><span class="line">        &#125; <span class="keyword">elseif</span> ( <span class="keyword">$this</span>-&gt;gender == <span class="keyword">self</span>::GENDER_FEMALE ) &#123;</span><br><span class="line">            $displayName .= <span class="keyword">self</span>::GENDER_FEMALE_DISPLAY_VALUE;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> ( <span class="keyword">$this</span>-&gt;namePrefix ) &#123;</span><br><span class="line">            $displayName .= <span class="string">' '</span> . <span class="keyword">$this</span>-&gt;namePrefix;</span><br><span class="line">        &#125;</span><br><span class="line">        $displayName .= <span class="string">' '</span> . <span class="keyword">$this</span>-&gt;firstName . <span class="string">' '</span> . <span class="keyword">$this</span>-&gt;lastName;</span><br><span class="line">        <span class="keyword">return</span> $displayName;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">UserTest</span> <span class="keyword">extends</span> <span class="title">PHPUnit_Framework_TestCase</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">testAssembleDisplayName</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        $user = <span class="keyword">new</span> User();</span><br><span class="line">        $user-&gt;setFirstName( <span class="string">'Max'</span> );</span><br><span class="line">        $user-&gt;setLastName( <span class="string">'Mustermann'</span> );</span><br><span class="line">        $user-&gt;setGender( <span class="number">0</span> );</span><br><span class="line">        $user-&gt;setNamePrefix( <span class="string">'Prof. Dr'</span> );</span><br><span class="line">        <span class="keyword">$this</span>-&gt;assertEquals(<span class="string">"Mr. Prof. Dr Max Mustermann"</span>,$user-&gt;assembleDisplayName());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>上面测试了User的一个功能，一般来说User都是从数据库中获取的，我们来写一段代码，测试下从数据库中读取的方式</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">testLoadFromDataBase</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        $db       = <span class="keyword">new</span> \PDO( <span class="string">'mysql:host=127.0.0.1;dbname=app;port=33060'</span>, <span class="string">'root'</span>, <span class="string">'root'</span> );</span><br><span class="line">        $userData = $db-&gt;query( <span class="string">'SELECT * FROM users WHERE id = 1'</span> )-&gt;fetch();</span><br><span class="line">        $user = <span class="keyword">new</span> Entity\User();</span><br><span class="line">        $user-&gt;setId( $userData[<span class="string">'id'</span>] );</span><br><span class="line">        $user-&gt;setFirstName( $userData[<span class="string">'first_name'</span>] );</span><br><span class="line">        $user-&gt;setLastName( $userData[<span class="string">'last_name'</span>] );</span><br><span class="line">        $user-&gt;setGender( $userData[<span class="string">'gender'</span>] );</span><br><span class="line">        $user-&gt;setNamePrefix( $userData[<span class="string">'name_prefix'</span>] );</span><br><span class="line">        <span class="keyword">$this</span>-&gt;assertEquals( <span class="string">"Mr. Prof. Dr. Max Mustermann"</span>, $user-&gt;assembleDisplayName() );</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>上面代码就是一个简易的ORM，从数据库中加载数据，然后将其转换为Object，让我们更进一步，将这些“data mapping”功能单独抽取出来，叫做Mapper：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">Mapper</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">User</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> $mapping = [</span><br><span class="line">        <span class="string">'id'</span>         =&gt; <span class="string">'id'</span>,</span><br><span class="line">        <span class="string">'firstName'</span>  =&gt; <span class="string">'first_name'</span>,</span><br><span class="line">        <span class="string">'lastName'</span>   =&gt; <span class="string">'last_name'</span>,</span><br><span class="line">        <span class="string">'gender'</span>     =&gt; <span class="string">'gender'</span>,</span><br><span class="line">        <span class="string">'namePrefix'</span> =&gt; <span class="string">'name_prefix'</span>,</span><br><span class="line">    ];</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">populate</span><span class="params">( $data, $user )</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        $mappingsFlipped = array_flip( <span class="keyword">$this</span>-&gt;mapping );</span><br><span class="line">        <span class="keyword">foreach</span> ( $data <span class="keyword">as</span> $key =&gt; $value ) &#123;</span><br><span class="line">            <span class="keyword">if</span> ( <span class="keyword">isset</span>( $mappingsFlipped[ $key ] ) ) &#123;</span><br><span class="line">                call_user_func_array(</span><br><span class="line">                    [ $user, <span class="string">'set'</span> . ucfirst( $mappingsFlipped[ $key ] ) ],</span><br><span class="line">                    [ $value ]</span><br><span class="line">                );</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> $user;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>此处我们再来看测试代码：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">testPopulate</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line"></span><br><span class="line">        $db       = <span class="keyword">new</span> \PDO( <span class="string">'mysql:host=127.0.0.1;dbname=app;port=33060'</span>, <span class="string">'root'</span>, <span class="string">'root'</span> );</span><br><span class="line">        $userData = $db-&gt;query( <span class="string">'SELECT * FROM users WHERE id = 1'</span> )-&gt;fetch();</span><br><span class="line">        $user       = <span class="keyword">new</span> Entity\User();</span><br><span class="line">        $userMapper = <span class="keyword">new</span> Mapper\User();</span><br><span class="line">        $user       = $userMapper-&gt;populate( $userData, $user );</span><br><span class="line">        <span class="keyword">$this</span>-&gt;assertEquals( <span class="string">"Mr. Prof. Dr. Max Mustermann"</span>, $user-&gt;assembleDisplayName() );</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>上面代码已经将数据映射的功能进行了封装，下一步，我们将sql语句抽离出来，封装到Repository中：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span> <span class="keyword">namespace</span> <span class="title">Repository</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">use</span> <span class="title">Mapper</span>\<span class="title">User</span> <span class="title">as</span> <span class="title">UserMapper</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">Entity</span>\<span class="title">User</span> <span class="title">as</span> <span class="title">UserEntity</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">User</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/** <span class="doctag">@var</span>  \EntityManager */</span></span><br><span class="line">    <span class="keyword">private</span> $em;</span><br><span class="line">    <span class="keyword">private</span> $mapper;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">( $em )</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;mapper = <span class="keyword">new</span> UserMapper;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;em     = $em;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">findOneById</span><span class="params">( $id )</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        $userData = <span class="keyword">$this</span>-&gt;em</span><br><span class="line">            -&gt;query( <span class="string">'SELECT * FROM users WHERE id = '</span> . $id )</span><br><span class="line">            -&gt;fetch();</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;mapper-&gt;populate( $userData, <span class="keyword">new</span> UserEntity() );</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>此处有个类叫<strong><em>EntityManager</em></strong>，其职责是作为数据库操作的Entry Point，负责所有的具体的数据库操作：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">use</span> <span class="title">Repository</span>\<span class="title">User</span> <span class="title">as</span> <span class="title">UserRepository</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">Repository</span>\<span class="title">Post</span> <span class="title">as</span> <span class="title">PostRepository</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">Mapper</span>\<span class="title">User</span> <span class="title">as</span> <span class="title">UserMapper</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">EntityManager</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> $host;</span><br><span class="line">    <span class="keyword">private</span> $db;</span><br><span class="line">    <span class="keyword">private</span> $user;</span><br><span class="line">    <span class="keyword">private</span> $pwd;</span><br><span class="line">    <span class="keyword">private</span> $port;</span><br><span class="line">    <span class="keyword">private</span> $connection;</span><br><span class="line">    <span class="keyword">private</span> $userRepository;</span><br><span class="line">    <span class="keyword">private</span> $postRepository;</span><br><span class="line">    <span class="keyword">private</span> $identityMap;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">( $host, $db, $port, $user, $pwd )</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;host           = $host;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;user           = $user;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;pwd            = $pwd;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;connection     = <span class="keyword">new</span> \PDO( <span class="string">"mysql:host=$host;port=$port;dbname=$db"</span>, $user, $pwd );</span><br><span class="line">        <span class="keyword">$this</span>-&gt;userRepository = <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;postRepository = <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;db             = $db;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;identityMap    = [ <span class="string">'users'</span> =&gt; [] ];</span><br><span class="line">        <span class="keyword">$this</span>-&gt;port = $port;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">query</span><span class="params">( $stmt )</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;connection-&gt;query( $stmt );</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">getUserRepository</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> ( !is_null( <span class="keyword">$this</span>-&gt;userRepository ) ) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;userRepository;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">$this</span>-&gt;userRepository = <span class="keyword">new</span> UserRepository( <span class="keyword">$this</span> );</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;userRepository;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>此时我们的测试代码变为了：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">UserRepositoryTest</span> <span class="keyword">extends</span> \<span class="title">PHPUnit_Framework_TestCase</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">testPopulate</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        $em = <span class="keyword">new</span> \EntityManager(<span class="string">'127.0.0.1'</span>,<span class="string">'app'</span>,<span class="number">33060</span>,<span class="string">'root'</span>,<span class="string">'root'</span>);</span><br><span class="line">        $repository = <span class="keyword">new</span> Repository\User($em);</span><br><span class="line">        $user = $repository-&gt;findOneById(<span class="number">1</span>);</span><br><span class="line">        <span class="keyword">$this</span>-&gt;assertEquals( <span class="string">"Mr. Prof. Dr. Max Mustermann"</span>, $user-&gt;assembleDisplayName() );</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>到目前为止我们做的事情就是将数据从数据库中读取出来，然后根据数据构造出对象，下面我们再进一步，看怎么对对象进行持久化。</p>
<h2 id="保存数据"><a href="#保存数据" class="headerlink" title="保存数据"></a>保存数据</h2><p>保存操作有两种：insert、update，先来看准备动作，将数据从对象Entity中取出来：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// class Mapper\User	</span></span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">extract</span><span class="params">( $user )</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        $data = [];</span><br><span class="line">        <span class="keyword">foreach</span> ( <span class="keyword">$this</span>-&gt;mapping <span class="keyword">as</span> $keyObject =&gt; $keyColumn ) &#123;</span><br><span class="line">            <span class="keyword">if</span> ( $keyColumn != <span class="keyword">$this</span>-&gt;getIdColumn() ) &#123;</span><br><span class="line">                $data[ $keyColumn ] = call_user_func(</span><br><span class="line">                    [ $user, <span class="string">'get'</span> . ucfirst( $keyObject ) ]</span><br><span class="line">                );</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> $data;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>在EntityManager中新增saveUser方法：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">saveUser</span><span class="params">( $user )</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    $userMapper = <span class="keyword">new</span> UserMapper();</span><br><span class="line">    $data       = $userMapper-&gt;extract( $user );</span><br><span class="line">    $userId     = call_user_func(</span><br><span class="line">        [ $user, <span class="string">'get'</span> . ucfirst( $userMapper-&gt;getIdColumn() ) ]</span><br><span class="line">    );</span><br><span class="line">    <span class="keyword">if</span> ( array_key_exists( $userId, <span class="keyword">$this</span>-&gt;identityMap[<span class="string">'users'</span>] ) ) &#123;</span><br><span class="line">        $setString = <span class="string">''</span>;</span><br><span class="line">        <span class="keyword">foreach</span> ( $data <span class="keyword">as</span> $key =&gt; $value ) &#123;</span><br><span class="line">            $setString .= $key . <span class="string">"='$value',"</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;query(</span><br><span class="line">            <span class="string">"UPDATE users SET "</span> . substr( $setString, <span class="number">0</span>, <span class="number">-1</span> ) .</span><br><span class="line">            <span class="string">" WHERE "</span> . $userMapper-&gt;getIdColumn() . <span class="string">"="</span> . $userId</span><br><span class="line">        );</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        $columnsString = implode( <span class="string">", "</span>, array_keys( $data ) );</span><br><span class="line">        $valuesString  = implode( <span class="string">"', '"</span>, $data );</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;query(</span><br><span class="line">            <span class="string">"INSERT INTO users ($columnsString) VALUES('$valuesString')"</span></span><br><span class="line">        );</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>此时新增一个User的方法如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line"></span><br><span class="line">class EntityManagerTest extends PHPUnit_Framework_TestCase &#123;</span><br><span class="line"></span><br><span class="line">    public function testSaveUser()</span><br><span class="line">    &#123;</span><br><span class="line">        $em      &#x3D; new \EntityManager( &#39;127.0.0.1&#39;, &#39;app&#39;, 33060, &#39;root&#39;, &#39;root&#39; );</span><br><span class="line">        $newUser &#x3D; new Entity\User();</span><br><span class="line">        $newUser-&gt;setFirstName( &#39;Ute&#39; );</span><br><span class="line">        $newUser-&gt;setLastName( &#39;Musermann&#39; );</span><br><span class="line">        $newUser-&gt;setGender( 1 );</span><br><span class="line">        $em-&gt;saveUser( $newUser );</span><br><span class="line">        $this-&gt;assertEquals(&quot;Mrs. Ute Musermann&quot;,$newUser-&gt;assembleDisplayName());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>此处在saveUser中使用了identity map模式，通过记录已经load的entity，减少从数据库中重新加载数据。</p>
<h2 id="关系"><a href="#关系" class="headerlink" title="关系"></a>关系</h2><p>用户有多个Posts，通过User的getPosts方法可以获取posts，因此有下面的代码：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;&#x2F; class Entity\User</span><br><span class="line">public function getPosts()</span><br><span class="line">&#123;</span><br><span class="line">    if ( is_null( $this-&gt;posts ) ) &#123;</span><br><span class="line">        $this-&gt;posts &#x3D; $this-&gt;postRepository-&gt;findByUser( $this );</span><br><span class="line">    &#125;</span><br><span class="line">    return $this-&gt;posts;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>此时为了能够获取posts，需要初始化postRepository，最好的初始化地方就是Repository\User中的findOneById，看代码:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">public function findOneById( $id )</span><br><span class="line">&#123;</span><br><span class="line">    $userData &#x3D; $this-&gt;em-&gt;query(&#39;SELECT * FROM users WHERE id &#x3D; &#39; . $id)-&gt;fetch();</span><br><span class="line">    $newUser &#x3D; new UserEntity();</span><br><span class="line">    $newUser-&gt;setPostRepository($this-&gt;em-&gt;getPostRepository());</span><br><span class="line">    return $this-&gt;em-&gt;registerUserEntity(</span><br><span class="line">        $id,</span><br><span class="line">        $this-&gt;mapper-&gt;populate($userData, $newUser)</span><br><span class="line">    );</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>最后要配套的Post的Entity，Mapper，Repository，然后是findByUser方法的实现</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;&#x2F; class Repository\Post</span><br><span class="line">public function findByUser( UserEntity $user )</span><br><span class="line">&#123;</span><br><span class="line">    $postsData &#x3D; $this-&gt;em</span><br><span class="line">        -&gt;query( &#39;SELECT * FROM posts WHERE user_id &#x3D; &#39; . $user-&gt;getId() )-&gt;fetchAll();</span><br><span class="line">    $posts     &#x3D; [];</span><br><span class="line">    foreach ( $postsData as $postData ) &#123;</span><br><span class="line">        $newPost &#x3D; new PostEntity();</span><br><span class="line">        $posts[] &#x3D; $this-&gt;mapper-&gt;populate( $postData, $newPost );</span><br><span class="line">    &#125;</span><br><span class="line">    return $posts;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>此时让我们回过头来看下项目结构：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">src</span><br><span class="line">├── Entity</span><br><span class="line">│   ├── Post.php</span><br><span class="line">│   └── User.php</span><br><span class="line">├── EntityManager.php</span><br><span class="line">├── Mapper</span><br><span class="line">│   ├── Post.php</span><br><span class="line">│   └── User.php</span><br><span class="line">└── Repository</span><br><span class="line">    ├── Post.php</span><br><span class="line">    └── User.php</span><br></pre></td></tr></table></figure>

<p>此时我们已经具备了基本的orm框架了，再往下就会越来越复杂了，下一篇让我们来看下doctrine的实现的。</p>
<p>本文完整的代码可以查看<a href="https://github.com/zhuanxuhit/doctrine-learn" target="_blank" rel="noopener">https://github.com/zhuanxuhit/doctrine-learn</a></p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  
  <div>
  
  </div>

        
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block home" lang="zh-Hans">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2016/12/16/Wormhole/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/uploads/wechat-qcode.jpg">
      <meta itemprop="name" content="颛顼">
      <meta itemprop="description" content="从小白到大神，一路走来，你我相伴">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="程序猿的进击之路">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          
            <a href="/2016/12/16/Wormhole/" class="post-title-link" itemprop="url">Wormhole:可靠的发布-订阅系统</a>
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2016-12-16 18:46:40" itemprop="dateCreated datePublished" datetime="2016-12-16T18:46:40+08:00">2016-12-16</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2020-02-22 20:18:44" itemprop="dateModified" datetime="2020-02-22T20:18:44+08:00">2020-02-22</time>
              </span>

          
            <span id="/2016/12/16/Wormhole/" class="post-meta-item leancloud_visitors" data-flag-title="Wormhole:可靠的发布-订阅系统" title="Views">
              <span class="post-meta-item-icon">
                <i class="fa fa-eye"></i>
              </span>
              <span class="post-meta-item-text">Views: </span>
              <span class="leancloud-visitors-count"></span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>Wormhole是Facebook内部使用的一个Pub-Sub系统，目前还没有开源。<br>在网上搜索论文相关内容的时候，发现几个网站，首先是该篇论文有个视频：<a href="https://www.usenix.org/conference/nsdi15/technical-sessions/presentation/sharma，由此知道了OSDI" target="_blank" rel="noopener">https://www.usenix.org/conference/nsdi15/technical-sessions/presentation/sharma，由此知道了OSDI</a>(Operating Systems Design and Implementation )大会，并且搜索到一个最佳论文的网址：<a href="https://www.usenix.org/conferences/best-papers，以后可以关注下。" target="_blank" rel="noopener">https://www.usenix.org/conferences/best-papers，以后可以关注下。</a><br>第二个发现的好的内容是：<a href="https://blog.acolyer.org/2015/05/14/wormhole-reliable-pub-sub-to-support-geo-replicated-internet-services/，该博客会每天推送一篇论文，特别棒。" target="_blank" rel="noopener">https://blog.acolyer.org/2015/05/14/wormhole-reliable-pub-sub-to-support-geo-replicated-internet-services/，该博客会每天推送一篇论文，特别棒。</a><br>第3个是发现的一个学校课程：<a href="https://courses.engr.illinois.edu/cs525/sched.htm，里面有介绍该篇论文的ppt，其他内容也特别棒，可以关注下。" target="_blank" rel="noopener">https://courses.engr.illinois.edu/cs525/sched.htm，里面有介绍该篇论文的ppt，其他内容也特别棒，可以关注下。</a></p>
<p>下面开始正式开始论文阅读，本文是mit 6.824课程的第16课学习记录。</p>
<hr>
<h2 id="意义"><a href="#意义" class="headerlink" title="意义"></a>意义</h2><p>首先回答下，我们为什么阅读这篇论文，pub-sub在分布式系统中常见的模块，也已经有好多类似的系统，如Kafka，SIENA，Thialﬁ，RabbitMQ等等，那为什么又来了一个Wormhole呢？</p>
<p>不像其他pub-sub系统，Wormhole没有自己的存储来保存消息，它也不需要数据源在原有的更新路径上去插入一个操作来发送消息，是非侵入式的，那Wormhole怎么获取到更新的数据呢？</p>
<p>Wormhole目前支持的数据源有 MySQL, HDFS, 和 RocksDB，Wormhole直接扫描transaction logs，Wormhole直接部署在数据源的机器上，这样子还带来一个好处，Wormhole本身不需要做任何的地域复制（geo-replication）的策略，只需要依赖于数据源的geo-replication策略即可。当本地的sub收到update通知的时候，意味着本地的数据源也已经收到更新了。</p>
<p>下面阐述下Wormhole的出现是为了解决什么问题？</p>
<ol>
<li>不同的消费速度：应用消费更新的速度不同，慢速应用不应该阻碍快消费的应用。</li>
<li>至少一次语义：所有的更新至少通知一次。</li>
<li>更新的有序性：当新更新到来的时候，应确保之前所有的更新都已经通知过了。</li>
<li>容错：系统需要能应对数据源和应用的错误。</li>
</ol>
<h2 id="架构"><a href="#架构" class="headerlink" title="架构"></a>架构</h2><p><img src="http://bos.nj.bpc.baidu.com/v1/agroup/205ba4d080a68176fd5776ba4e9add0899d3d821" alt="图片"><br>Wormhole通过读取事务日志来获取更新，但是最后传递给sub的更新都是格式统一的key-value形式，称为：Wormhole update。</p>
<p>Wormhole将所有的订阅者信息存储在基于ZooKeeper的配置系统中，订阅者收到的一系列updates称为<strong><em>flow</em></strong>，每个flow都会维护一个当前订阅者已经消费的更新位置，这个信息是由在publisher维护的，每个flow都会有这个信息，称为<strong><em>datamarkers</em></strong>，那如何更新这个信息呢？如果采用传统的应用ack机制，会对性能造成影响，于是采取的做法是周期性的ack机制，另一个原因是由于pub和sub之间采用tcp通信，我们可以不用担心消息丢失，可以放心的周期性更新<strong><em>datamarkers</em></strong>。</p>
<blockquote>
<p>A datamarker for a flow is essentially a pointer in the datastore log that indicates the position of the last received and acknowledged update of the flow by the subscriber.</p>
</blockquote>
<p>下面回答下一个问题：<strong><em>datamarkers</em></strong>存储在哪？<br>Wormhole支持两种类型的数据中心：单副本和多副本，多副本一般是多地域分布数据中心。于是Wormhole就有了两种投递：</p>
<ul>
<li>single-copy reliable delivery (SCRD)  </li>
<li>multiple-copy reliable delivery (MCRD).</li>
</ul>
<p>对于SCRD，<strong><em>datamarkers</em></strong>可以直接存储在本地的存储设备上，因为存储设备挂了，markers丢失也无所谓了。<br>对于MCRD，markers存储在zookeeper上，如果一个publisher挂了，新的publisher可以从zookeeper中读取markers，接着发送。但是这带来的一个问题是不同的副本，其存储的位置可能不同，如图：<br><img src="http://bos.nj.bpc.baidu.com/v1/agroup/4e7bf1c945fe3ae0327ac29f73e3d39a54c3947b" alt="图片"><br>于是就发明了logical position。但是经常性的同步数据到zookeeper会有性能损耗，因此也是周期性的动作。</p>
<h2 id="优化"><a href="#优化" class="headerlink" title="优化"></a>优化</h2><p>回到之前提过的Wormhole有别于其他pub-sub系统的一个点就是直接读取transaction log，这样子就会导致对于db读压来大，于是就有了优化Caravan，其背后的思想是：如果每个flow都有一个reader，会对DB造成太大的负载，而且稳定的情况下，其实每个reader读取到的都是同样的updates；如果所有的flows都是同一个reader呢？这会造成速度不一样的应用都需要同样速度读，那解决方案自然就是相同速度的flows分配一个reader，叫caravan，给出一张图<br><img src="http://bos.nj.bpc.baidu.com/v1/agroup/70f88fab2ddb94ab3177887d86771942b650406b" alt="图片"><br>可以看到caravan多，延迟就少，但是读压力大，caravan少，延迟大，但是读压力小。</p>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>Wormhole提供了一个不一样的pub-sub系统，Wormhole利用了存储系统的transaction log来提供一个可靠的、有序的更新事件流，并能支持单副本和多副本数据存储，通过优化读取transaction log尽可能降低对原存储系统的压力。</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  
  <div>
  
  </div>

        
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block home" lang="zh-Hans">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2016/12/16/dynamo/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/uploads/wechat-qcode.jpg">
      <meta itemprop="name" content="颛顼">
      <meta itemprop="description" content="从小白到大神，一路走来，你我相伴">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="程序猿的进击之路">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          
            <a href="/2016/12/16/dynamo/" class="post-title-link" itemprop="url">Dynamo：Amazon的高可用性的键-值存储系统</a>
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2016-12-16 10:25:19" itemprop="dateCreated datePublished" datetime="2016-12-16T10:25:19+08:00">2016-12-16</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2020-02-22 20:18:44" itemprop="dateModified" datetime="2020-02-22T20:18:44+08:00">2020-02-22</time>
              </span>

          
            <span id="/2016/12/16/dynamo/" class="post-meta-item leancloud_visitors" data-flag-title="Dynamo：Amazon的高可用性的键-值存储系统" title="Views">
              <span class="post-meta-item-icon">
                <i class="fa fa-eye"></i>
              </span>
              <span class="post-meta-item-text">Views: </span>
              <span class="leancloud-visitors-count"></span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p><img src="http://bos.nj.bpc.baidu.com/v1/agroup/fdbf9914e778a4ccb07ee21b79966be52a899d7a" alt=""></p>
<p>Dynamo是一个分布式键值系统，最初用于支持购物车系统，强调的是提供一个<strong>“永远在线“</strong>的用户体验。</p>
<p>根据CAP理论不可能同时达到一致性、可用性和分区容忍，于是Dynamo选择了AP，放弃了一致性。</p>
<p>Dynamo在设计时遇到的问题及解决方案（来源大规模分布式存储系统第5章）<br>| 问题        | 采取的技术                                    |<br>| ——— | —————————————- |<br>| 数据分布      | 改进的一致性哈希（虚拟节点）                           |<br>| 复制协议      | 复制写协议（Replicated-write protocol,NRW参数可调） |<br>| 数据冲突处理    | 向量时钟                                     |<br>| 临时故障处理    | 数据回传机制                                   |<br>| 永久故障恢复    | Merkle哈希树                                |<br>| 成员资格及错误检测 | 基于Gossip的成员资格和错误检测协议                     |</p>
<h2 id="数据分布"><a href="#数据分布" class="headerlink" title="数据分布"></a>数据分布</h2><p>Dynamo是是一个P2P（peer-to-peer）系统，需要解决怎么快速定位key的位置，答案是DHT（distributed hash table），并且Dynamo为了保证快速响应，就需要保证最快的定位key，于是每个node都保存了整个集群的信息，客户端也缓存了集群信息，保证能将请求直接转发到目标node，达到<strong>zero-hop</strong>。</p>
<p>Dynamo采用一致性哈希的方法来定位key到node，采用一致性哈希的优点是：<br>节点加入和退出时，只影响哈希环中相邻的节点。<br>接着考虑到每个节点的异构性，其处理能力不同，于是加入了虚拟节点的概念，尽可能做到每个虚拟节点处理能力一样。</p>
<p>对于一致性哈希算法，用php实现个简单版本：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Ring</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">protected</span> $hashMap = [];</span><br><span class="line">    <span class="keyword">protected</span> $keys    = [];</span><br><span class="line">    <span class="keyword">protected</span> $hashFunc;</span><br><span class="line">    <span class="keyword">protected</span> $replicas;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Ring constructor.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> $hashFunc</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> $replicas</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">( $hashFunc = null, $replicas = <span class="number">3</span> )</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;hashFunc = $hashFunc;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;replicas = $replicas;</span><br><span class="line">        <span class="keyword">if</span> ( !is_callable( <span class="keyword">$this</span>-&gt;hashFunc ) ) &#123;</span><br><span class="line">            <span class="keyword">$this</span>-&gt;hashFunc = <span class="string">'crc32'</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">add</span><span class="params">( $keys )</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> ( !is_array( $keys ) ) &#123;</span><br><span class="line">            $keys = func_get_args();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">foreach</span> ( $keys <span class="keyword">as</span> $key ) &#123;</span><br><span class="line">            <span class="keyword">for</span> ( $i = <span class="number">0</span>; $i &lt; <span class="keyword">$this</span>-&gt;replicas; $i++ ) &#123;</span><br><span class="line">                $hash = call_user_func( <span class="keyword">$this</span>-&gt;hashFunc, $i . $key );</span><br><span class="line">                array_unshift( <span class="keyword">$this</span>-&gt;keys, $hash );</span><br><span class="line">                <span class="keyword">$this</span>-&gt;hashMap[ $hash ] = $key;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        sort( <span class="keyword">$this</span>-&gt;keys );</span><br><span class="line"><span class="comment">//        $this-&gt;keys = array_reverse( $this-&gt;keys );</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">   </span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">get</span><span class="params">( $key )</span>: <span class="title">string</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> ( <span class="keyword">empty</span>( <span class="keyword">$this</span>-&gt;keys ) ) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="string">''</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        $hash = call_user_func( <span class="keyword">$this</span>-&gt;hashFunc, $key );</span><br><span class="line"></span><br><span class="line">        $idx = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">foreach</span> (<span class="keyword">$this</span>-&gt;keys <span class="keyword">as</span> $i =&gt; $value)&#123;</span><br><span class="line">            <span class="keyword">if</span> ($value &gt;= $hash)&#123;</span><br><span class="line">                $idx = $i;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;hashMap[ <span class="keyword">$this</span>-&gt;keys[ $idx ] ];</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">$hash = <span class="function"><span class="keyword">function</span> <span class="params">( $key )</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> (int)$key;</span><br><span class="line">&#125;;</span><br><span class="line">$ring = <span class="keyword">new</span> Ring( $hash, <span class="number">3</span> );</span><br><span class="line">$ring-&gt;add( <span class="number">2</span>, <span class="number">4</span>, <span class="number">6</span> );</span><br><span class="line">$testCases = [</span><br><span class="line">    <span class="string">"2"</span>  =&gt; <span class="string">"2"</span>,</span><br><span class="line">    <span class="string">"11"</span> =&gt; <span class="string">"2"</span>,</span><br><span class="line">    <span class="string">"23"</span> =&gt; <span class="string">"4"</span>,</span><br><span class="line">    <span class="string">"27"</span> =&gt; <span class="string">"2"</span>,</span><br><span class="line">];</span><br><span class="line"><span class="comment">//var_export($ring);</span></span><br><span class="line"><span class="keyword">foreach</span> ($testCases <span class="keyword">as</span> $key =&gt; $expected)&#123;</span><br><span class="line">    assert($ring-&gt;get($key) == $expected);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>原理很简单，看上面代码就能看懂，不多说了，更多的原理可以看<a href="http://blog.csdn.net/cywosp/article/details/23397179" target="_blank" rel="noopener">每天进步一点点——五分钟理解一致性哈希算法</a></p>
<p>起初一致性哈希是为了解决新加入节点和退出节点对数据的影响最小，但是由于数据分布的不均匀，热点数据，节点能力的异构都会造成分布不均匀，于是加入了virtual nodes，但是为了同一份数据的replicas分布式在不同的物理机器上，配置virtual也会造成一定的困难。</p>
<h2 id="一致性和复制"><a href="#一致性和复制" class="headerlink" title="一致性和复制"></a>一致性和复制</h2><p>为了应对数据丢失的风险，Dynamo也会对数据进行replicate，进行数据复制的node称为<em>coordinator</em>，而负责存储key的node被称为<em>preference list</em>。</p>
<p>此处当<em>coordinator</em>进行数据复制的时候，是异步进行的，为的就是尽可能快的给用户返回，因此Dynamo是一个弱一致的系统。</p>
<p>Dynamo的一个亮点是NRW，应用根据自己的需求，合理的调整R和W，但是需要满足：</p>
<blockquote>
<p>R + W &gt; N</p>
</blockquote>
<p>写操作参数W(W&lt;=N)，该值的含义是，一个写操作只有成功更新了W个副本，才会被认为操作成功。同样，读操作也有R(R&lt;=N)，这是一个读操作需要读取的副本数量。</p>
<p>R + W &gt; N能够保证读操作和写操作有节点交集。也就是，至少有一个节点会被读操作和写操作同时操作到。</p>
<p>通过调整R和W能实现available和consistency之间的转换。</p>
<p>给W配置一个小值R配置一个大值则”writes never fail”（high availablility）；给R配置一个小值W配置一个大值则”block for all replicas to be readable”（strong consistency）</p>
<p>下一个考虑的是数据冲突问题，看一个例子：<br><img src="http://bos.nj.bpc.baidu.com/v1/agroup/0084b9853a1d585430c3a3bc332a2ea671fff500" alt="conflict"><br>每个node都记录自己的操作记录，通过向量时钟能记录记录同一对象不同版本间的因果关系。当节点接收到更新，逐项对比本地向量钟和待更新数据的向量时钟。如果待更新数据的向量钟的每一项都不小于本地向量钟，那么数据无冲突，新的值可以被接受。Dynamo并不会贸然假定数据的冲突合并准则，而是保留全部的冲突数据，等待客户端处理。</p>
<h2 id="容错"><a href="#容错" class="headerlink" title="容错"></a>容错</h2><p>Dynamo将异常分为两种：</p>
<ul>
<li>临时性问题</li>
<li>永久性问题</li>
</ul>
<p>针对临时性故障，其处理策略是仲裁（quorum），但是如果严格执行仲裁策略，会影响Dynamo的可用性，因为需要等到N个都执行了，才能返回，此时如果其中一个临时故障了，会影响可用性。</p>
<p>于是Dynamo采用了<em>sloppy quorum*策略，只需要N个 *healthy node</em> 即可，具体是指：如果某台机器故障了，则顺延将数据写入到后面的健康机器，并标注数据为hinted handoff,当机器恢复后，将数据进行回传。</p>
<p>针对永久性故障，我们解决方案是Merkle哈希树。Merkle的原理是：每个非叶子节点对应多个文件，值是其所有子节点值组合以后的哈希值，叶子节点对应单个数据文件，值是文件内容的哈希。通过比对Merkle树，就能找出不同的文件了。</p>
<h2 id="成员资格及错误检测"><a href="#成员资格及错误检测" class="headerlink" title="成员资格及错误检测"></a>成员资格及错误检测</h2><p>最开始介绍过一致性哈希，为了保证能够直接找到key对应的node，因此所有的node中都保存了集群中所有node的路由信息，这就导致有新节点加入或者节点推出的时候，需要将这信息传递给集群内的所有人，于是就有了Gossip</p>
<p><img src="https://qph.ec.quoracdn.net/main-qimg-58adb5bde4a054436bd0298c2eef49d5?convert_to_webp=true" alt=""><br>从上图中能看到Gossip就是在AP系统中特有的，<br>在看下下面这张图，说明了Gossip算法<br><img src="https://leanote.com/api/file/getImage?fileId=5778766aab6441481a000d71" alt=""><br>1传3，3传9，9传27，快速扩散，然后整个集群就都知道了。</p>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>本文只是对Dynamo简单阅读，好多问题还没有阐述清楚，以后有了深入阅读后再来继续补充的，就目前来说，先对Dynamo做个总结，Dynamo总体特点是：</p>
<ul>
<li>最终一致性</li>
<li>即使故障的时候也要保证可写</li>
<li>允许写冲突，让应用自己解决</li>
</ul>
<h2 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h2><p><a href="http://www.jianshu.com/p/2f1778231868" target="_blank" rel="noopener">百万节点数据库扩展之道(2): NoSQL理论与Amazon Dynamo</a><br><a href="http://systemdesigns.blogspot.tw/2016/01/dynamodb.html" target="_blank" rel="noopener">DynamoDB（理论篇）</a></p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  
  <div>
  
  </div>

        
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block home" lang="zh-Hans">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2016/12/06/eloquent-6/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/uploads/wechat-qcode.jpg">
      <meta itemprop="name" content="颛顼">
      <meta itemprop="description" content="从小白到大神，一路走来，你我相伴">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="程序猿的进击之路">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          
            <a href="/2016/12/06/eloquent-6/" class="post-title-link" itemprop="url">repository实作</a>
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2016-12-06 15:24:37" itemprop="dateCreated datePublished" datetime="2016-12-06T15:24:37+08:00">2016-12-06</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2020-02-22 20:18:44" itemprop="dateModified" datetime="2020-02-22T20:18:44+08:00">2020-02-22</time>
              </span>

          
            <span id="/2016/12/06/eloquent-6/" class="post-meta-item leancloud_visitors" data-flag-title="repository实作" title="Views">
              <span class="post-meta-item-icon">
                <i class="fa fa-eye"></i>
              </span>
              <span class="post-meta-item-text">Views: </span>
              <span class="leancloud-visitors-count"></span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p><img src="https://bosnadev.com/wp-content/uploads/2015/03/laravel_repository_pattern1.png" alt=""></p>
<h2 id="Repository缘由"><a href="#Repository缘由" class="headerlink" title="Repository缘由"></a>Repository缘由</h2><p>本文将介绍Repository的实作，基于的github项目是：<a href="https://github.com/andersao/l5-repository" target="_blank" rel="noopener">l5-repository</a>，源码是做好的教科书，代码面前所有设计意图都无所遁形。</p>
<p>我们首先来明确下需要解决的问题是什么，为什么会出现<a href="https://github.com/andersao/l5-repository" target="_blank" rel="noopener">l5-repository</a>这个项目。</p>
<p>我想你肯定遇到过这个问题：刚开始我们的Model只有几百行，但是呢，随着项目功能的不断复杂，model需要实现的功能也越来越多，当我们有一天突然回过头去看的时候，发现Model已经上千行了，我们自己也想不起来里面都有哪些功能了。</p>
<p>那model为什么会<strong>越来越胖</strong>呢？我们来看下model中都可能会有哪些功能。</p>
<ul>
<li>php写的业务逻辑</li>
<li>依据显示需求，我们做的数据格式转换，字段的选择性返回</li>
<li>各种条件的查询</li>
<li>对于创建参数、查询参数的验证</li>
<li>…..</li>
</ul>
<p>根据分类，我们可以归纳为下面几类</p>
<ol>
<li>presenter，显示需求</li>
<li>repository，存取需求</li>
<li>validator，参数验证需求</li>
<li>services，业务逻辑</li>
</ol>
<p>于是我们就有了下面的架构图：</p>
<p><img src="http://oomusou.io/images/laravel/laravel-architecture/arch002.svg" alt="图片来自电灯坊"></p>
<p>有了这个图以后，我们再来看<a href="https://github.com/andersao/l5-repository" target="_blank" rel="noopener">l5-repository</a>这个项目的实现，就会容易理解很多。</p>
<p>下面我会从3个方面来讲解<a href="https://github.com/andersao/l5-repository" target="_blank" rel="noopener">l5-repository</a>的实现：repository，presenter，validator。我们先来看repository的实现。</p>
<h2 id="repository原理"><a href="#repository原理" class="headerlink" title="repository原理"></a>repository原理</h2><p>开始时，我也免不了一般的套路，先来个repository的定义</p>
<blockquote>
<p>A Repository mediates between the domain and data mapping layers, acting like an in-memory domain object collection. Client objects construct query specifications declaratively and submit them to Repository for satisfaction. Objects can be added to and removed from the Repository, as they can from a simple collection of objects, and the mapping code encapsulated by the Repository will carry out the appropriate operations behind the scenes.</p>
</blockquote>
<p>其核心有两点</p>
<ul>
<li>repository类似于集合，负责对象的存取，隐藏了具体的data mapping的实现</li>
<li>repository能根据client构建的查询条件，返回特定的数据</li>
</ul>
<p>我们先来看第一点，对象存取，说到底就是CRUD操作，于是就有了repository的接口定义<code>RepositoryInterface</code>，具体的接口有：</p>
<p><img src="http://bos.nj.bpc.baidu.com/v1/agroup/aaf0ed4d8c3a9382135ec89c729f28fac7e46497" alt=""></p>
<p>对于CRUD来说，其最难的是C操作，因为会有各种各样的查询方式，提供的查询接口有：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">find</span><span class="params">($id, $columns = [<span class="string">'*'</span>])</span></span>;</span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">findByField</span><span class="params">($field, $value, $columns = [<span class="string">'*'</span>])</span></span>;</span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">findWhere</span><span class="params">(array $where, $columns = [<span class="string">'*'</span>])</span></span>;</span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">findWhereIn</span><span class="params">($field, array $values, $columns = [<span class="string">'*'</span>])</span></span>;</span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">findWhereNotIn</span><span class="params">($field, array $values, $columns = [<span class="string">'*'</span>])</span></span>;</span><br></pre></td></tr></table></figure>

<p>然后默认的实现是<code>Prettus\Repository\Eloquent\BaseRepository</code>，基本上就是对<code>Eloquent\Builder</code>的一个封装。</p>
<p>但是一些更复杂的查询怎么满足呢？我们难道需要每次有新的查询都去新增findCondition接口吗？显然我们不能这么做，这个时候<code>Criteria</code>就隆重登场了，先看个接口：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">interface</span> <span class="title">CriteriaInterface</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Apply criteria in query repository</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span>                     $model</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> RepositoryInterface $repository</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> mixed</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">apply</span><span class="params">($model, RepositoryInterface $repository)</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>所有的Criteria都需要实现apply方法，看一个可能是实现：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">LengthOverTwoHours</span> <span class="keyword">implements</span> <span class="title">CriteriaInterface</span> </span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">apply</span><span class="params">($model, Repository $repository)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        $query = $model-&gt;where(<span class="string">'length'</span>, <span class="string">'&gt;'</span>, <span class="number">120</span>);</span><br><span class="line">        <span class="keyword">return</span> $query;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>通过定义LengthOverTwoHours来对Model新增查询，这样子我们每次有新的查询条件，只要新建Criteria即可，满足了开放封闭原则。</p>
<p>接着我们来使用下<a href="https://github.com/andersao/l5-repository" target="_blank" rel="noopener">l5-repository</a>。首先通过命令<code>php artisan make:entity Book</code>来生成文件，然后在AppServiceProvider@register中新增</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">$this</span>-&gt;app-&gt;register( RepositoryServiceProvider::class);</span><br></pre></td></tr></table></figure>

<p>接着产生一个Controller</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">php artisan make:controller -r BookController</span><br></pre></td></tr></table></figure>

<p>在里面我们可以使用注入进Repository</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">( BookRepository $bookRepository )</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  	<span class="keyword">$this</span>-&gt;bookRepository = $bookRepository;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>然后一些具体的操作可以去看<a href="https://github.com/andersao/l5-repository，写的非常详细。" target="_blank" rel="noopener">https://github.com/andersao/l5-repository，写的非常详细。</a></p>
<p>最后介绍下怎么产生criteria，通过下面的命令</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">php artisan make:criteria My</span><br></pre></td></tr></table></figure>

<p>然后添加下面代码</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MyCriteria</span> <span class="keyword">implements</span> <span class="title">CriteriaInterface</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Apply criteria in query repository</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> Builder                    $model</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> RepositoryInterface $repository</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> mixed</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">apply</span><span class="params">($model, RepositoryInterface $repository)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        $model = $model-&gt;where(<span class="string">'user_id'</span>,<span class="string">'='</span>, \Auth::user()-&gt;id );</span><br><span class="line">        <span class="keyword">return</span> $model;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>就能够使用了，然后在controller中，我们通过下面的方式查询</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">public function index()</span><br><span class="line">&#123;</span><br><span class="line">  $this-&gt;repository-&gt;pushCriteria(new MyCriteria());</span><br><span class="line">  $books &#x3D; $this-&gt;repository-&gt;all();</span><br><span class="line">  ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="Presenters优化"><a href="#Presenters优化" class="headerlink" title="Presenters优化"></a>Presenters优化</h2><p>接着我们讲Presenters部分。</p>
<p>我们再强调下Presenter解决的问题：把日期、金额、名称之类的呈现（presentation）逻辑抽离出来。在<a href="https://github.com/andersao/l5-repository" target="_blank" rel="noopener">l5-repository</a>这个功能其实不是很满意，我们希望的是<a href="http://slides.com/howtomakeaturn/model#/7" target="_blank" rel="noopener">1 Presenter</a>中介绍的那种样子，原先样子是：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Article</span> <span class="keyword">extends</span> <span class="title">Eloquent</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">getDate</span><span class="params">()</span></span>&#123;<span class="comment">/*...*/</span>&#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">getTaiwaneseDateTime</span><span class="params">()</span></span>&#123;<span class="comment">/*...*/</span>&#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">getWesternDateTime</span><span class="params">()</span></span>&#123;<span class="comment">/*...*/</span>&#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">getTaiwaneseDate</span><span class="params">()</span></span>&#123;<span class="comment">/*...*/</span>&#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">getWesternDate</span><span class="params">()</span></span>&#123;<span class="comment">/*...*/</span>&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>抽离出来后是：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Article</span> <span class="keyword">extends</span> <span class="title">Eloquent</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">present</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> ArticlePresenter(<span class="keyword">$this</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ArticlePresenter</span> <span class="keyword">extends</span> <span class="title">Presenter</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">getTaiwaneseDateTime</span><span class="params">()</span></span>&#123;<span class="comment">/*...*/</span>&#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">getWesternDateTime</span><span class="params">()</span></span>&#123;<span class="comment">/*...*/</span>&#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">getTaiwaneseDate</span><span class="params">()</span></span>&#123;<span class="comment">/*...*/</span>&#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">getWesternDate</span><span class="params">()</span></span>&#123;<span class="comment">/*...*/</span>&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>下面是一些实现方案</p>
<p><a href="https://github.com/laracasts/Presenter" target="_blank" rel="noopener">https://github.com/laracasts/Presenter</a></p>
<p><a href="https://github.com/robclancy/presenter" target="_blank" rel="noopener">https://github.com/robclancy/presenter</a></p>
<p><a href="https://github.com/laravel-auto-presenter/laravel-auto-presenter" target="_blank" rel="noopener">https://github.com/laravel-auto-presenter/laravel-auto-presenter</a></p>
<h2 id="参数验证"><a href="#参数验证" class="headerlink" title="参数验证"></a>参数验证</h2><p>最后我们介绍validator</p>
<p>validator的逻辑从model中抽离出来，单独放入一个类中，</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">use</span> \<span class="title">Prettus</span>\<span class="title">Validator</span>\<span class="title">Contracts</span>\<span class="title">ValidatorInterface</span>;</span><br><span class="line"><span class="keyword">use</span> \<span class="title">Prettus</span>\<span class="title">Validator</span>\<span class="title">LaravelValidator</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">PostValidator</span> <span class="keyword">extends</span> <span class="title">LaravelValidator</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">protected</span> $rules = [</span><br><span class="line">        ValidatorInterface::RULE_CREATE =&gt; [</span><br><span class="line">            <span class="string">'title'</span> =&gt; <span class="string">'required'</span>,</span><br><span class="line">            <span class="string">'text'</span>  =&gt; <span class="string">'min:3'</span>,</span><br><span class="line">            <span class="string">'author'</span>=&gt; <span class="string">'required'</span></span><br><span class="line">        ],</span><br><span class="line">        ValidatorInterface::RULE_UPDATE =&gt; [</span><br><span class="line">            <span class="string">'title'</span> =&gt; <span class="string">'required'</span></span><br><span class="line">        ]</span><br><span class="line">   ];</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>能够制定create和update操作的时候不同的验证规则。</p>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>以上就是repository的全部，文章开头由实际项目中model越来越胖引出如何给model瘦身，接着对model中的功能进行了划分，给出了合理的项目组织方式，接着通过从repository，presenter，validator分析了具体的一些优化方式。</p>
<p>最后本文只是简单的对<a href="https://github.com/andersao/l5-repository" target="_blank" rel="noopener">l5-repository</a>进行了介绍，更详细的功能，更多的实现细节，你都可以clone项目下来，自己好好去看，相信会学到很多。</p>
<h2 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h2><p><a href="http://slides.com/howtomakeaturn/model#/" target="_blank" rel="noopener">胖胖Model減重的五個方法</a></p>
<p><a href="https://bosnadev.com/2015/03/07/using-repository-pattern-in-laravel-5" target="_blank" rel="noopener">Using Repository Pattern in Laravel 5</a></p>
<p><a href="http://blog.turn.tw/?p=2511" target="_blank" rel="noopener">胖胖 MODEL 的減重方法：PRESENTER</a></p>
<p><a href="http://oomusou.io/laravel/laravel-architecture/" target="_blank" rel="noopener">Laravel 的中大型專案架構</a></p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  
  <div>
  
  </div>

        
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block home" lang="zh-Hans">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2016/12/04/eloquent-5/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/uploads/wechat-qcode.jpg">
      <meta itemprop="name" content="颛顼">
      <meta itemprop="description" content="从小白到大神，一路走来，你我相伴">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="程序猿的进击之路">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          
            <a href="/2016/12/04/eloquent-5/" class="post-title-link" itemprop="url">通过Eloquent实现Repository模式</a>
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2016-12-04 12:56:03" itemprop="dateCreated datePublished" datetime="2016-12-04T12:56:03+08:00">2016-12-04</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2020-02-22 20:18:44" itemprop="dateModified" datetime="2020-02-22T20:18:44+08:00">2020-02-22</time>
              </span>

          
            <span id="/2016/12/04/eloquent-5/" class="post-meta-item leancloud_visitors" data-flag-title="通过Eloquent实现Repository模式" title="Views">
              <span class="post-meta-item-icon">
                <i class="fa fa-eye"></i>
              </span>
              <span class="post-meta-item-text">Views: </span>
              <span class="leancloud-visitors-count"></span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p><img src="http://bos.nj.bpc.baidu.com/v1/agroup/47f7847030e12ec9b13bda3393d853235eff1308" alt=""></p>
          <!--noindex-->
            <div class="post-button">
              <a class="btn" href="/2016/12/04/eloquent-5/#more" rel="contents">
                Read more &raquo;
              </a>
            </div>
          <!--/noindex-->
        
      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  
  <div>
  
  </div>

        
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block home" lang="zh-Hans">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2016/12/02/collections-1/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/uploads/wechat-qcode.jpg">
      <meta itemprop="name" content="颛顼">
      <meta itemprop="description" content="从小白到大神，一路走来，你我相伴">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="程序猿的进击之路">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          
            <a href="/2016/12/02/collections-1/" class="post-title-link" itemprop="url">Say No to Loop!</a>
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2016-12-02 14:06:12" itemprop="dateCreated datePublished" datetime="2016-12-02T14:06:12+08:00">2016-12-02</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2020-02-22 20:18:44" itemprop="dateModified" datetime="2020-02-22T20:18:44+08:00">2020-02-22</time>
              </span>

          
            <span id="/2016/12/02/collections-1/" class="post-meta-item leancloud_visitors" data-flag-title="Say No to Loop!" title="Views">
              <span class="post-meta-item-icon">
                <i class="fa fa-eye"></i>
              </span>
              <span class="post-meta-item-text">Views: </span>
              <span class="leancloud-visitors-count"></span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>本文会介绍下<code>Eloquent\Collection</code>，这个是什么呢？这是我们平常使用Eloquent中<code>get,all</code>返回的结果集。</p>
<h2 id="collection缘来"><a href="#collection缘来" class="headerlink" title="collection缘来"></a>collection缘来</h2><p>我们首先来看一段简单的代码：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">$books = Book::all();</span><br><span class="line">$titles = [];</span><br><span class="line"><span class="keyword">foreach</span> ($books <span class="keyword">as</span> $book)&#123;</span><br><span class="line">  <span class="keyword">if</span> ($book-&gt;pages_count &gt; <span class="number">8</span>)&#123;</span><br><span class="line">    $titles[] =  $book-&gt;title;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这段代码意图其实非常明确，就是获取超过8的书名，再看下面一段代码：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">$titles = [];</span><br><span class="line"><span class="keyword">foreach</span> ($books <span class="keyword">as</span> $book)&#123;</span><br><span class="line">  <span class="keyword">if</span> ($book-&gt;publisher_id == <span class="number">2</span>)&#123;</span><br><span class="line">    $titles[] =  $book-&gt;title;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>此处是获取作者是2的书名，所有这些代码都有同样的loop逻辑，我们完全可以抽取出来，于是就有了下面的函数：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">map</span><span class="params">($input, $func)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    $result = [];</span><br><span class="line">    <span class="keyword">foreach</span> ($input <span class="keyword">as</span> $each)</span><br><span class="line">    &#123;</span><br><span class="line">        $result[] = $func($each);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> $result;</span><br><span class="line">&#125;</span><br><span class="line">map($books, <span class="function"><span class="keyword">function</span><span class="params">($book)</span></span>&#123;</span><br><span class="line">  <span class="keyword">if</span> ($book-&gt;publisher_id == <span class="number">2</span>)&#123;</span><br><span class="line">    <span class="keyword">return</span> $book-&gt;title;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<p>这只是展示了一个简单的map模式，还有其他更多方便的集合操作方法，我们将其抽取出来，于是就出现了Collection，网上有个讲<a href="https://adamwathan.me/refactoring-to-collections" target="_blank" rel="noopener">Collection</a>的课程，不过太贵了，买不起。</p>
<p>其实Collection的总体思想感觉就是函数式编程，Tell, Don’t Ask，客户端在使用上不再是想着怎么做how，而是想着what to do，一直有个神一样存在的系列文章没去读，今天看到collection的文章，有了冲动去看的，文章地址：<a href="https://bartoszmilewski.com/2014/10/28/category-theory-for-programmers-the-preface/" target="_blank" rel="noopener">Category Theory for Programmers: The Preface</a>，等最近看完orm系列就去看这个的。我们还是接着讲collection。</p>
<h2 id="collection使用"><a href="#collection使用" class="headerlink" title="collection使用"></a>collection使用</h2><p>在使用collection的原则上，我们遵守当代码出现loop的时候，我们就停下来想下，是否可以通过collection来解决。</p>
<h3 id="first"><a href="#first" class="headerlink" title="first"></a>first</h3><p>三种使用方式</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">testFirstReturnsFirstItemInCollection</span><span class="params">()</span></span></span><br><span class="line"><span class="function">   </span>&#123;</span><br><span class="line">       $c = <span class="keyword">new</span> Collection([<span class="string">'foo'</span>, <span class="string">'bar'</span>]);</span><br><span class="line">       <span class="keyword">$this</span>-&gt;assertEquals(<span class="string">'foo'</span>, $c-&gt;first());</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">testFirstWithCallback</span><span class="params">()</span></span></span><br><span class="line"><span class="function">   </span>&#123;</span><br><span class="line">       $data = <span class="keyword">new</span> Collection([<span class="string">'foo'</span>, <span class="string">'bar'</span>, <span class="string">'baz'</span>]);</span><br><span class="line">       $result = $data-&gt;first(<span class="function"><span class="keyword">function</span> <span class="params">($value)</span> </span>&#123;</span><br><span class="line">           <span class="keyword">return</span> $value === <span class="string">'bar'</span>;</span><br><span class="line">       &#125;);</span><br><span class="line">       <span class="keyword">$this</span>-&gt;assertEquals(<span class="string">'bar'</span>, $result);</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">testFirstWithCallbackAndDefault</span><span class="params">()</span></span></span><br><span class="line"><span class="function">   </span>&#123;</span><br><span class="line">       $data = <span class="keyword">new</span> Collection([<span class="string">'foo'</span>, <span class="string">'bar'</span>]);</span><br><span class="line">       $result = $data-&gt;first(<span class="function"><span class="keyword">function</span> <span class="params">($value)</span> </span>&#123;</span><br><span class="line">           <span class="keyword">return</span> $value === <span class="string">'baz'</span>;</span><br><span class="line">       &#125;, <span class="string">'default'</span>);</span><br><span class="line">       <span class="keyword">$this</span>-&gt;assertEquals(<span class="string">'default'</span>, $result);</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>

<h3 id="last"><a href="#last" class="headerlink" title="last"></a>last</h3><p>和first使用方式相同</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">testLastReturnsLastItemInCollection</span><span class="params">()</span></span></span><br><span class="line"><span class="function">   </span>&#123;</span><br><span class="line">       $c = <span class="keyword">new</span> Collection([<span class="string">'foo'</span>, <span class="string">'bar'</span>]);</span><br><span class="line">       <span class="keyword">$this</span>-&gt;assertEquals(<span class="string">'bar'</span>, $c-&gt;last());</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">testLastWithCallback</span><span class="params">()</span></span></span><br><span class="line"><span class="function">   </span>&#123;</span><br><span class="line">       $data = <span class="keyword">new</span> Collection([<span class="number">100</span>, <span class="number">200</span>, <span class="number">300</span>]);</span><br><span class="line">       $result = $data-&gt;last(<span class="function"><span class="keyword">function</span> <span class="params">($value)</span> </span>&#123;</span><br><span class="line">           <span class="keyword">return</span> $value &lt; <span class="number">250</span>;</span><br><span class="line">       &#125;);</span><br><span class="line">       <span class="keyword">$this</span>-&gt;assertEquals(<span class="number">200</span>, $result);</span><br><span class="line">       $result = $data-&gt;last(<span class="function"><span class="keyword">function</span> <span class="params">($value, $key)</span> </span>&#123;</span><br><span class="line">           <span class="keyword">return</span> $key &lt; <span class="number">2</span>;</span><br><span class="line">       &#125;);</span><br><span class="line">       <span class="keyword">$this</span>-&gt;assertEquals(<span class="number">200</span>, $result);</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">testLastWithCallbackAndDefault</span><span class="params">()</span></span></span><br><span class="line"><span class="function">   </span>&#123;</span><br><span class="line">       $data = <span class="keyword">new</span> Collection([<span class="string">'foo'</span>, <span class="string">'bar'</span>]);</span><br><span class="line">       $result = $data-&gt;last(<span class="function"><span class="keyword">function</span> <span class="params">($value)</span> </span>&#123;</span><br><span class="line">           <span class="keyword">return</span> $value === <span class="string">'baz'</span>;</span><br><span class="line">       &#125;, <span class="string">'default'</span>);</span><br><span class="line">       <span class="keyword">$this</span>-&gt;assertEquals(<span class="string">'default'</span>, $result);</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>

<h3 id="map"><a href="#map" class="headerlink" title="map"></a>map</h3><p>map是对loop的抽离，对于集合中每个元素做完操作后，再返回新的元素。</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">testMap</span><span class="params">()</span></span></span><br><span class="line"><span class="function">   </span>&#123;</span><br><span class="line">       $data = <span class="keyword">new</span> Collection([<span class="string">'first'</span> =&gt; <span class="string">'taylor'</span>, <span class="string">'last'</span> =&gt; <span class="string">'otwell'</span>]);</span><br><span class="line">       $data = $data-&gt;map(<span class="function"><span class="keyword">function</span> <span class="params">($item, $key)</span> </span>&#123;</span><br><span class="line">           <span class="keyword">return</span> $key.<span class="string">'-'</span>.strrev($item);</span><br><span class="line">       &#125;);</span><br><span class="line">       <span class="keyword">$this</span>-&gt;assertEquals([<span class="string">'first'</span> =&gt; <span class="string">'first-rolyat'</span>, <span class="string">'last'</span> =&gt; <span class="string">'last-llewto'</span>], $data-&gt;all());</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>

<h3 id="each"><a href="#each" class="headerlink" title="each"></a>each</h3><p>遍历元组进行操作，不返回元素操作后的结果，当遇到返回false的时候，结束遍历。</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">testEach</span><span class="params">()</span></span></span><br><span class="line"><span class="function">   </span>&#123;</span><br><span class="line">       $c = <span class="keyword">new</span> Collection($original = [<span class="number">1</span>, <span class="number">2</span>, <span class="string">'foo'</span> =&gt; <span class="string">'bar'</span>, <span class="string">'bam'</span> =&gt; <span class="string">'baz'</span>]);</span><br><span class="line"></span><br><span class="line">       $result = [];</span><br><span class="line">       $c-&gt;each(<span class="function"><span class="keyword">function</span> <span class="params">($item, $key)</span> <span class="title">use</span> <span class="params">(&amp;$result)</span> </span>&#123;</span><br><span class="line">           $result[$key] = $item;</span><br><span class="line">       &#125;);</span><br><span class="line">       <span class="keyword">$this</span>-&gt;assertEquals($original, $result);</span><br><span class="line"></span><br><span class="line">       $result = [];</span><br><span class="line">       $c-&gt;each(<span class="function"><span class="keyword">function</span> <span class="params">($item, $key)</span> <span class="title">use</span> <span class="params">(&amp;$result)</span> </span>&#123;</span><br><span class="line">           $result[$key] = $item;</span><br><span class="line">           <span class="keyword">if</span> (is_string($key)) &#123;</span><br><span class="line">               <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">           &#125;</span><br><span class="line">       &#125;);</span><br><span class="line">       <span class="keyword">$this</span>-&gt;assertEquals([<span class="number">1</span>, <span class="number">2</span>, <span class="string">'foo'</span> =&gt; <span class="string">'bar'</span>], $result);</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>

<h3 id="filter"><a href="#filter" class="headerlink" title="filter"></a>filter</h3><p>遍历集合，只将符合条件的留下，集合中元素的性质不会变，如果集合中是product，返回的也是product，不会像map那样，返回price</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">testFilter</span><span class="params">()</span></span></span><br><span class="line"><span class="function">   </span>&#123;</span><br><span class="line">       $c = <span class="keyword">new</span> Collection([[<span class="string">'id'</span> =&gt; <span class="number">1</span>, <span class="string">'name'</span> =&gt; <span class="string">'Hello'</span>], [<span class="string">'id'</span> =&gt; <span class="number">2</span>, <span class="string">'name'</span> =&gt; <span class="string">'World'</span>]]);</span><br><span class="line">       <span class="keyword">$this</span>-&gt;assertEquals([<span class="number">1</span> =&gt; [<span class="string">'id'</span> =&gt; <span class="number">2</span>, <span class="string">'name'</span> =&gt; <span class="string">'World'</span>]], $c-&gt;filter(<span class="function"><span class="keyword">function</span> <span class="params">($item)</span> </span>&#123;</span><br><span class="line">           <span class="keyword">return</span> $item[<span class="string">'id'</span>] == <span class="number">2</span>;</span><br><span class="line">       &#125;)-&gt;all());</span><br><span class="line"></span><br><span class="line">       $c = <span class="keyword">new</span> Collection([<span class="string">''</span>, <span class="string">'Hello'</span>, <span class="string">''</span>, <span class="string">'World'</span>]);</span><br><span class="line">       <span class="keyword">$this</span>-&gt;assertEquals([<span class="string">'Hello'</span>, <span class="string">'World'</span>], $c-&gt;filter()-&gt;values()-&gt;toArray());</span><br><span class="line"></span><br><span class="line">       $c = <span class="keyword">new</span> Collection([<span class="string">'id'</span> =&gt; <span class="number">1</span>, <span class="string">'first'</span> =&gt; <span class="string">'Hello'</span>, <span class="string">'second'</span> =&gt; <span class="string">'World'</span>]);</span><br><span class="line">       <span class="keyword">$this</span>-&gt;assertEquals([<span class="string">'first'</span> =&gt; <span class="string">'Hello'</span>, <span class="string">'second'</span> =&gt; <span class="string">'World'</span>], $c-&gt;filter(<span class="function"><span class="keyword">function</span> <span class="params">($item, $key)</span> </span>&#123;</span><br><span class="line">           <span class="keyword">return</span> $key != <span class="string">'id'</span>;</span><br><span class="line">       &#125;)-&gt;all());</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>

<h3 id="reduce"><a href="#reduce" class="headerlink" title="reduce"></a>reduce</h3><p>reduce将一个集合中的元素做遍历，返回为一个单子的元素</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">public function testReduce()</span><br><span class="line">&#123;</span><br><span class="line">    $data &#x3D; new Collection([1, 2, 3]);</span><br><span class="line">    $this-&gt;assertEquals(6, $data-&gt;reduce(function ($carry, $element) &#123;</span><br><span class="line">        return $carry +&#x3D; $element;</span><br><span class="line">    &#125;));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="flatten"><a href="#flatten" class="headerlink" title="flatten"></a>flatten</h3><p>flatten意为平坦，可以将任意嵌套的array变为同层级的，通过参数depth，可以指定平坦的层级</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">public function testFlatten()</span><br><span class="line">&#123;</span><br><span class="line">    &#x2F;&#x2F; Flat arrays are unaffected</span><br><span class="line">    $c &#x3D; new Collection([&#39;#foo&#39;, &#39;#bar&#39;, &#39;#baz&#39;]);</span><br><span class="line">    $this-&gt;assertEquals([&#39;#foo&#39;, &#39;#bar&#39;, &#39;#baz&#39;], $c-&gt;flatten()-&gt;all());</span><br><span class="line"></span><br><span class="line">    &#x2F;&#x2F; Nested arrays are flattened with existing flat items</span><br><span class="line">    $c &#x3D; new Collection([[&#39;#foo&#39;, &#39;#bar&#39;], &#39;#baz&#39;]);</span><br><span class="line">    $this-&gt;assertEquals([&#39;#foo&#39;, &#39;#bar&#39;, &#39;#baz&#39;], $c-&gt;flatten()-&gt;all());</span><br><span class="line"></span><br><span class="line">    &#x2F;&#x2F; Sets of nested arrays are flattened</span><br><span class="line">    $c &#x3D; new Collection([[&#39;#foo&#39;, &#39;#bar&#39;], [&#39;#baz&#39;]]);</span><br><span class="line">    $this-&gt;assertEquals([&#39;#foo&#39;, &#39;#bar&#39;, &#39;#baz&#39;], $c-&gt;flatten()-&gt;all());</span><br><span class="line"></span><br><span class="line">    &#x2F;&#x2F; Deeply nested arrays are flattened</span><br><span class="line">    $c &#x3D; new Collection([[&#39;#foo&#39;, [&#39;#bar&#39;]], [&#39;#baz&#39;]]);</span><br><span class="line">    $this-&gt;assertEquals([&#39;#foo&#39;, &#39;#bar&#39;, &#39;#baz&#39;], $c-&gt;flatten()-&gt;all());</span><br><span class="line">&#125;</span><br><span class="line">public function testFlattenWithDepth()</span><br><span class="line">&#123;</span><br><span class="line">  &#x2F;&#x2F; No depth flattens recursively</span><br><span class="line">  $c &#x3D; new Collection([[&#39;#foo&#39;, [&#39;#bar&#39;, [&#39;#baz&#39;]]], &#39;#zap&#39;]);</span><br><span class="line">  $this-&gt;assertEquals([&#39;#foo&#39;, &#39;#bar&#39;, &#39;#baz&#39;, &#39;#zap&#39;], $c-&gt;flatten()-&gt;all());</span><br><span class="line"></span><br><span class="line">  &#x2F;&#x2F; Specifying a depth only flattens to that depth</span><br><span class="line">  $c &#x3D; new Collection([[&#39;#foo&#39;, [&#39;#bar&#39;, [&#39;#baz&#39;]]], &#39;#zap&#39;]);</span><br><span class="line">  $this-&gt;assertEquals([&#39;#foo&#39;, [&#39;#bar&#39;, [&#39;#baz&#39;]], &#39;#zap&#39;], $c-&gt;flatten(1)-&gt;all());</span><br><span class="line"></span><br><span class="line">  $c &#x3D; new Collection([[&#39;#foo&#39;, [&#39;#bar&#39;, [&#39;#baz&#39;]]], &#39;#zap&#39;]);</span><br><span class="line">  $this-&gt;assertEquals([&#39;#foo&#39;, &#39;#bar&#39;, [&#39;#baz&#39;], &#39;#zap&#39;], $c-&gt;flatten(2)-&gt;all());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="FlatMap"><a href="#FlatMap" class="headerlink" title="FlatMap"></a>FlatMap</h3><p>flatMap类似于做了先map后flat的操作</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">public function testFlatMap()</span><br><span class="line">&#123;</span><br><span class="line">    $data &#x3D; new Collection([</span><br><span class="line">        [&#39;name&#39; &#x3D;&gt; &#39;taylor&#39;, &#39;hobbies&#39; &#x3D;&gt; [&#39;programming&#39;, &#39;basketball&#39;]],</span><br><span class="line">        [&#39;name&#39; &#x3D;&gt; &#39;adam&#39;, &#39;hobbies&#39; &#x3D;&gt; [&#39;music&#39;, &#39;powerlifting&#39;]],</span><br><span class="line">    ]);</span><br><span class="line">    $data &#x3D; $data-&gt;flatMap(function ($person) &#123;</span><br><span class="line">        return $person[&#39;hobbies&#39;];</span><br><span class="line">    &#125;);</span><br><span class="line">    $this-&gt;assertEquals([&#39;programming&#39;, &#39;basketball&#39;, &#39;music&#39;, &#39;powerlifting&#39;], $data-&gt;all());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="zip"><a href="#zip" class="headerlink" title="zip"></a>zip</h3><p>吧两个结构一样的array像拉拉链一样做合并</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">public function testZip()</span><br><span class="line">&#123;</span><br><span class="line">    $c &#x3D; new Collection([1, 2, 3]);</span><br><span class="line">    $c &#x3D; $c-&gt;zip(new Collection([4, 5, 6]));</span><br><span class="line">    $this-&gt;assertInstanceOf(Collection::class, $c);</span><br><span class="line">    $this-&gt;assertInstanceOf(Collection::class, $c[0]);</span><br><span class="line">    $this-&gt;assertInstanceOf(Collection::class, $c[1]);</span><br><span class="line">    $this-&gt;assertInstanceOf(Collection::class, $c[2]);</span><br><span class="line">    $this-&gt;assertCount(3, $c);</span><br><span class="line">    $this-&gt;assertEquals([1, 4], $c[0]-&gt;all());</span><br><span class="line">    $this-&gt;assertEquals([2, 5], $c[1]-&gt;all());</span><br><span class="line">    $this-&gt;assertEquals([3, 6], $c[2]-&gt;all());</span><br><span class="line"></span><br><span class="line">    $c &#x3D; new Collection([1, 2, 3]);</span><br><span class="line">    $c &#x3D; $c-&gt;zip([4, 5, 6], [7, 8, 9]);</span><br><span class="line">    $this-&gt;assertCount(3, $c);</span><br><span class="line">    $this-&gt;assertEquals([1, 4, 7], $c[0]-&gt;all());</span><br><span class="line">    $this-&gt;assertEquals([2, 5, 8], $c[1]-&gt;all());</span><br><span class="line">    $this-&gt;assertEquals([3, 6, 9], $c[2]-&gt;all());</span><br><span class="line"></span><br><span class="line">    $c &#x3D; new Collection([1, 2, 3]);</span><br><span class="line">    $c &#x3D; $c-&gt;zip([4, 5, 6], [7]);</span><br><span class="line">    $this-&gt;assertCount(3, $c);</span><br><span class="line">    $this-&gt;assertEquals([1, 4, 7], $c[0]-&gt;all());</span><br><span class="line">    $this-&gt;assertEquals([2, 5, null], $c[1]-&gt;all());</span><br><span class="line">    $this-&gt;assertEquals([3, 6, null], $c[2]-&gt;all());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="pluck"><a href="#pluck" class="headerlink" title="pluck"></a>pluck</h3><p>pluck接受两个参数，如果传递了第二个参数，则以第二个参数为key</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">public function testPluckWithArrayAndObjectValues()</span><br><span class="line">&#123;</span><br><span class="line">    $data &#x3D; new Collection([(object) [&#39;name&#39; &#x3D;&gt; &#39;taylor&#39;, &#39;email&#39; &#x3D;&gt; &#39;foo&#39;], [&#39;name&#39; &#x3D;&gt; &#39;dayle&#39;, &#39;email&#39; &#x3D;&gt; &#39;bar&#39;]]);</span><br><span class="line">    $this-&gt;assertEquals([&#39;taylor&#39; &#x3D;&gt; &#39;foo&#39;, &#39;dayle&#39; &#x3D;&gt; &#39;bar&#39;], $data-&gt;pluck(&#39;email&#39;, &#39;name&#39;)-&gt;all());</span><br><span class="line">    $this-&gt;assertEquals([&#39;foo&#39;, &#39;bar&#39;], $data-&gt;pluck(&#39;email&#39;)-&gt;all());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>更详细的可以参考<a href="https://laravel.tw/docs/5.2/collections" target="_blank" rel="noopener">https://laravel.tw/docs/5.2/collections</a></p>
<h2 id="一些建议"><a href="#一些建议" class="headerlink" title="一些建议"></a>一些建议</h2><p>我们使用collection的取值的时候，如果没有对应的值，我们可以提供default值，此时可以在default中直接抛出异常</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">return</span> <span class="keyword">$this</span>-&gt;checkers-&gt;first(<span class="function"><span class="keyword">function</span> <span class="params">($i, $checker)</span> <span class="title">use</span> <span class="params">( $file)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> $checker-&gt;canCheck($file);</span><br><span class="line">&#125;, <span class="function"><span class="keyword">function</span> <span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> <span class="keyword">Exception</span>(<span class="string">"No matching style checker found!"</span>);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<p>我们有时候为了连贯操作，即使前一个出错了，我们也不希望返回一个null object，我们希望能返回一个空对象，但是这个对象实现了一个空操作，意图如下：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">$this</span>-&gt;getObject($input)-&gt;check();</span><br></pre></td></tr></table></figure>

<p>此处getObject($input)可能返回是一个实现了check操作的空对象，这时候就可以使用Macroable trait 的东西。</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">testMacroable</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">// Foo() macro : unique values starting with A</span></span><br><span class="line">    Collection::macro(<span class="string">'foo'</span>, <span class="function"><span class="keyword">function</span> <span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;filter(<span class="function"><span class="keyword">function</span> <span class="params">($item)</span> </span>&#123;</span><br><span class="line">            <span class="keyword">return</span> strpos($item, <span class="string">'a'</span>) === <span class="number">0</span>;</span><br><span class="line">        &#125;)</span><br><span class="line">            -&gt;unique()</span><br><span class="line">            -&gt;values();</span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">    $c = <span class="keyword">new</span> Collection([<span class="string">'a'</span>, <span class="string">'a'</span>, <span class="string">'aa'</span>, <span class="string">'aaa'</span>, <span class="string">'bar'</span>]);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">$this</span>-&gt;assertSame([<span class="string">'a'</span>, <span class="string">'aa'</span>, <span class="string">'aaa'</span>], $c-&gt;foo()-&gt;all());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>更多内容大家可以去看文章<a href="https://medium.com/@guitarbien/refactoring-to-collection-%E8%AE%80%E5%BE%8C%E5%BF%83%E5%BE%97-9f8de89e4efc#.6yt89aaev" target="_blank" rel="noopener">Refactoring to Collection — Notes</a></p>
<h2 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h2><p><a href="https://medium.com/@guitarbien/refactoring-to-collection-%E8%AE%80%E5%BE%8C%E5%BF%83%E5%BE%97-9f8de89e4efc#.6yt89aaev" target="_blank" rel="noopener">Refactoring to Collection — Notes</a></p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  
  <div>
  
  </div>

        
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block home" lang="zh-Hans">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2016/12/01/eloquent-4/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/uploads/wechat-qcode.jpg">
      <meta itemprop="name" content="颛顼">
      <meta itemprop="description" content="从小白到大神，一路走来，你我相伴">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="程序猿的进击之路">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          
            <a href="/2016/12/01/eloquent-4/" class="post-title-link" itemprop="url">orm 系列 之 Eloquent使用2</a>
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2016-12-01 14:10:50" itemprop="dateCreated datePublished" datetime="2016-12-01T14:10:50+08:00">2016-12-01</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2020-02-22 20:18:44" itemprop="dateModified" datetime="2020-02-22T20:18:44+08:00">2020-02-22</time>
              </span>

          
            <span id="/2016/12/01/eloquent-4/" class="post-meta-item leancloud_visitors" data-flag-title="orm 系列 之 Eloquent使用2" title="Views">
              <span class="post-meta-item-icon">
                <i class="fa fa-eye"></i>
              </span>
              <span class="post-meta-item-text">Views: </span>
              <span class="leancloud-visitors-count"></span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p><img src="http://bos.nj.bpc.baidu.com/v1/agroup/0dfce87000d9cb71ad2031cdccb9c268e187b3d8" alt=""></p>
<p>上一篇介绍了Eloquent的migrations和Scheme Builder功能，本文介绍Eloquent最重要的Model。</p>
          <!--noindex-->
            <div class="post-button">
              <a class="btn" href="/2016/12/01/eloquent-4/#more" rel="contents">
                Read more &raquo;
              </a>
            </div>
          <!--/noindex-->
        
      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  
  <div>
  
  </div>

        
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block home" lang="zh-Hans">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2016/11/28/eloquent-3/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/uploads/wechat-qcode.jpg">
      <meta itemprop="name" content="颛顼">
      <meta itemprop="description" content="从小白到大神，一路走来，你我相伴">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="程序猿的进击之路">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          
            <a href="/2016/11/28/eloquent-3/" class="post-title-link" itemprop="url">orm 系列 之 Eloquent使用1</a>
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2016-11-28 19:26:00" itemprop="dateCreated datePublished" datetime="2016-11-28T19:26:00+08:00">2016-11-28</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2020-02-22 20:18:44" itemprop="dateModified" datetime="2020-02-22T20:18:44+08:00">2020-02-22</time>
              </span>

          
            <span id="/2016/11/28/eloquent-3/" class="post-meta-item leancloud_visitors" data-flag-title="orm 系列 之 Eloquent使用1" title="Views">
              <span class="post-meta-item-icon">
                <i class="fa fa-eye"></i>
              </span>
              <span class="post-meta-item-text">Views: </span>
              <span class="leancloud-visitors-count"></span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p><img src="http://bos.nj.bpc.baidu.com/v1/agroup/0dfce87000d9cb71ad2031cdccb9c268e187b3d8" alt="Eloquent ORM"></p>
<p>本文会是一个Eloquent的使用教程，在此之前，我们先讲述下怎么搭建环境，完整的目录请查看<a href="http://www.jianshu.com/collection/d935bff99c7a" target="_blank" rel="noopener">orm</a></p>
          <!--noindex-->
            <div class="post-button">
              <a class="btn" href="/2016/11/28/eloquent-3/#more" rel="contents">
                Read more &raquo;
              </a>
            </div>
          <!--/noindex-->
        
      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  
  <div>
  
  </div>

        
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block home" lang="zh-Hans">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2016/11/27/eloquent-2/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/uploads/wechat-qcode.jpg">
      <meta itemprop="name" content="颛顼">
      <meta itemprop="description" content="从小白到大神，一路走来，你我相伴">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="程序猿的进击之路">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          
            <a href="/2016/11/27/eloquent-2/" class="post-title-link" itemprop="url">orm 系列 之 Eloquent演化历程2</a>
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2016-11-27 16:50:28" itemprop="dateCreated datePublished" datetime="2016-11-27T16:50:28+08:00">2016-11-27</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2020-02-22 20:18:44" itemprop="dateModified" datetime="2020-02-22T20:18:44+08:00">2020-02-22</time>
              </span>

          
            <span id="/2016/11/27/eloquent-2/" class="post-meta-item leancloud_visitors" data-flag-title="orm 系列 之 Eloquent演化历程2" title="Views">
              <span class="post-meta-item-icon">
                <i class="fa fa-eye"></i>
              </span>
              <span class="post-meta-item-text">Views: </span>
              <span class="leancloud-visitors-count"></span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p><img src="http://bos.nj.bpc.baidu.com/v1/agroup/2f10325b69cc4b1dd7264c5a05e53edba013ba7e" alt="Eloquent ORM"></p>
<p>上篇讲到了数据库Relation的实现，本篇接着讲<strong>migrations or database modification logic</strong>的功能，此处开始的git是<code>gic coaa98553</code>。</p>
          <!--noindex-->
            <div class="post-button">
              <a class="btn" href="/2016/11/27/eloquent-2/#more" rel="contents">
                Read more &raquo;
              </a>
            </div>
          <!--/noindex-->
        
      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  
  <div>
  
  </div>

        
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block home" lang="zh-Hans">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2016/11/24/eloquent-1/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/uploads/wechat-qcode.jpg">
      <meta itemprop="name" content="颛顼">
      <meta itemprop="description" content="从小白到大神，一路走来，你我相伴">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="程序猿的进击之路">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          
            <a href="/2016/11/24/eloquent-1/" class="post-title-link" itemprop="url">orm 系列 之 Eloquent演化历程1</a>
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2016-11-24 16:41:46" itemprop="dateCreated datePublished" datetime="2016-11-24T16:41:46+08:00">2016-11-24</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2020-02-22 20:18:44" itemprop="dateModified" datetime="2020-02-22T20:18:44+08:00">2020-02-22</time>
              </span>

          
            <span id="/2016/11/24/eloquent-1/" class="post-meta-item leancloud_visitors" data-flag-title="orm 系列 之 Eloquent演化历程1" title="Views">
              <span class="post-meta-item-icon">
                <i class="fa fa-eye"></i>
              </span>
              <span class="post-meta-item-text">Views: </span>
              <span class="leancloud-visitors-count"></span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p><img src="http://bos.nj.bpc.baidu.com/v1/agroup/36061fd902bc3fc7ea60039cc53fe23b568679ef" alt=""></p>
<p>Eloquent是laravel中的orm，采取的是active record的设计模式，里面的对象不仅包括领域逻辑，还包括了数据库操作，但是大家平时使用的时候可能没有探究eloquent是怎么设计的，active record这种模式的优缺点等问题，下面我会带领大家从头开始看看Eloquent是如何设计并实现的。</p>
          <!--noindex-->
            <div class="post-button">
              <a class="btn" href="/2016/11/24/eloquent-1/#more" rel="contents">
                Read more &raquo;
              </a>
            </div>
          <!--/noindex-->
        
      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  
  <div>
  
  </div>

  </div>

  
  <nav class="pagination">
    <a class="extend prev" rel="prev" href="/"><i class="fa fa-angle-left" aria-label="Previous page"></i></a><a class="page-number" href="/">1</a><span class="page-number current">2</span><a class="page-number" href="/page/3/">3</a><span class="space">&hellip;</span><a class="page-number" href="/page/6/">6</a><a class="extend next" rel="next" href="/page/3/"><i class="fa fa-angle-right" aria-label="Next page"></i></a>
  </nav>



          </div>
          

<script>
  window.addEventListener('tabs:register', () => {
    let activeClass = CONFIG.comments.activeClass;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          Table of Contents
        </li>
        <li class="sidebar-nav-overview">
          Overview
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="颛顼"
      src="/uploads/wechat-qcode.jpg">
  <p class="site-author-name" itemprop="name">颛顼</p>
  <div class="site-description" itemprop="description">从小白到大神，一路走来，你我相伴</div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">54</span>
          <span class="site-state-item-name">posts</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
        <span class="site-state-item-count">1</span>
        <span class="site-state-item-name">categories</span>
      </div>
      <div class="site-state-item site-state-tags">
        <span class="site-state-item-count">25</span>
        <span class="site-state-item-name">tags</span>
      </div>
  </nav>
</div>
  <div class="links-of-author motion-element">
      <span class="links-of-author-item">
        <a href="https://github.com/zhuanxuhit" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;zhuanxuhit" rel="noopener" target="_blank"><i class="fa fa-fw fa-github"></i>GitHub</a>
      </span>
      <span class="links-of-author-item">
        <a href="https://www.jianshu.com/u/b7f94092fc21" title="简书 → https:&#x2F;&#x2F;www.jianshu.com&#x2F;u&#x2F;b7f94092fc21" rel="noopener" target="_blank"><i class="fa fa-fw fa-book"></i>简书</a>
      </span>
  </div>



      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

<div class="copyright">
  
  &copy; 2016 – 
  <span itemprop="copyrightYear">2020</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">颛顼</span>
</div>
  <div class="powered-by">Powered by <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> v4.2.0
  </div>
  <span class="post-meta-divider">|</span>
  <div class="theme-info">Theme – <a href="https://pisces.theme-next.org/" class="theme-link" rel="noopener" target="_blank">NexT.Pisces</a> v7.7.1
  </div>

        






  <script>
  function leancloudSelector(url) {
    url = encodeURI(url);
    return document.getElementById(url).querySelector('.leancloud-visitors-count');
  }
  if (CONFIG.page.isPost) {
    function addCount(Counter) {
      var visitors = document.querySelector('.leancloud_visitors');
      var url = decodeURI(visitors.getAttribute('id'));
      var title = visitors.getAttribute('data-flag-title');

      Counter('get', `/classes/Counter?where=${JSON.stringify({ url })}`)
        .then(response => response.json())
        .then(({ results }) => {
          if (results.length > 0) {
            var counter = results[0];
            Counter('put', '/classes/Counter/' + counter.objectId, { time: { '__op': 'Increment', 'amount': 1 } })
              .then(response => response.json())
              .then(() => {
                leancloudSelector(url).innerText = counter.time + 1;
              })
              .catch(error => {
                console.error('Failed to save visitor count', error);
              })
          } else {
              leancloudSelector(url).innerText = 'Counter not initialized! More info at console err msg.';
              console.error('ATTENTION! LeanCloud counter has security bug, see how to solve it here: https://github.com/theme-next/hexo-leancloud-counter-security. \n However, you can still use LeanCloud without security, by setting `security` option to `false`.');
            
          }
        })
        .catch(error => {
          console.error('LeanCloud Counter Error', error);
        });
    }
  } else {
    function showTime(Counter) {
      var visitors = document.querySelectorAll('.leancloud_visitors');
      var entries = [...visitors].map(element => {
        return decodeURI(element.getAttribute('id'));
      });

      Counter('get', `/classes/Counter?where=${JSON.stringify({ url: { '$in': entries } })}`)
        .then(response => response.json())
        .then(({ results }) => {
          if (results.length === 0) {
            document.querySelectorAll('.leancloud_visitors .leancloud-visitors-count').forEach(element => {
              element.innerText = 0;
            });
            return;
          }
          for (let item of results) {
            let { url, time } = item;
            leancloudSelector(url).innerText = time;
          }
          for (let url of entries) {
            var element = leancloudSelector(url);
            if (element.innerText == '') {
              element.innerText = 0;
            }
          }
        })
        .catch(error => {
          console.error('LeanCloud Counter Error', error);
        });
    }
  }

  fetch('https://app-router.leancloud.cn/2/route?appId=TrQUAQIL1sooy48Tp02GkMER-gzGzoHsz')
    .then(response => response.json())
    .then(({ api_server }) => {
      var Counter = (method, url, data) => {
        return fetch(`https://${api_server}/1.1${url}`, {
          method: method,
          headers: {
            'X-LC-Id'     : 'TrQUAQIL1sooy48Tp02GkMER-gzGzoHsz',
            'X-LC-Key'    : '1aaerlJphDUxOYBg5DLMgzQV',
            'Content-Type': 'application/json',
          },
          body: JSON.stringify(data)
        });
      };
      if (CONFIG.page.isPost) {
        if (CONFIG.hostname !== location.hostname) return;
        addCount(Counter);
      } else if (document.querySelectorAll('.post-title-link').length >= 1) {
        showTime(Counter);
      }
    });
  </script>


      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/pisces.js"></script>


<script src="/js/next-boot.js"></script>




  















  

  


</body>
</html>
